# DeepSeek 接入逻辑与问答方式说明

## 一、当前（改进前）的接入逻辑

### 1. 整体流程

```
前端输入一句话 → POST /api/ai/assist { message: "..." } 
  → 后端 AiController 取出 message 
  → AiService.chat(message) 
  → 拼成「仅 2 条消息」的请求发给 DeepSeek： [system, user] 
  → 取 choices[0].message.content 作为 reply 返回前端
```

### 2. 问答生成方式（为何像「搜索」）

| 环节 | 实现 | 效果/问题 |
|------|------|-----------|
| **请求体** | 每次只发 `[system, user]` 两条消息，没有历史对话 | 模型不知道上一句说了什么，无法追问、澄清、连续对话 |
| **系统提示** | 固定一句「简要、友好、简短，别编造功能」 | 回答偏 FAQ/说明书式，没有「对话感」 |
| **用户上下文** | 无 | 不知道当前是谁、第几周、是否有草稿，无法个性化（如「您本周周报尚未提交」） |
| **业务数据** | 无 | 不能结合真实数据（如本周是否已交、团队统计）回答，只能泛泛而谈 |

所以整体是：**每轮独立、无记忆、无上下文的单轮 QA**，更像「关键词 + 固定说明」的搜索式回答，而不是有记忆、有上下文的智能对话。

### 3. 与 DeepSeek 的交互方式

- **接口**：`POST https://api.deepseek.com/v1/chat/completions`（OpenAI 兼容格式）
- **请求体**：`model`、`messages`、`max_tokens`
- **messages**：改进前仅为 `[{role: "system", content: systemPrompt}, {role: "user", content: 用户本条输入}]`
- **回复**：从响应 `choices[0].message.content` 取出文本，原样返回前端

---

## 二、改进后的设计（更「智能」的方向）

### 1. 多轮对话（带历史）

- **后端**：接口增加可选参数 `history`，格式为 `[{role, content}, ...]`（只含 user/assistant）。
- **AiService**：拼消息时变为 `[system, ...history 最近 N 轮, user]`，这样模型能看到当前对话的前文，能追问、指代、延续话题。
- **前端**：把当前会话里「已展示的」最近若干轮 user/assistant 在发新问题时一并传给后端。

这样「问答生成方式」从「单轮检索」变成「带会话历史的生成」。

### 2. 用户与业务上下文注入

- **后端**：从 JWT 或请求属性拿到当前用户（如 userId、username），可选再查当前周次、是否已有本周草稿等。
- 在拼 **system** 或第一条 **user** 时，注入一段「当前上下文」文本，例如：  
  「当前用户：张三；当前为第 3 周；本周周报尚未提交。」  
  模型即可基于这些信息做个性化回复（如提醒提交、说明「您可以在写周报页面……」）。

### 3. 系统提示（System Prompt）增强

- 不再只强调「简短、别编造」，而是给一个**角色设定**和**能力边界**，例如：
  - 身份：本系统的智能助手，负责解答使用问题、协助写周报、提醒待办。
  - 能力：可根据「当前用户、当前周次、是否已提交」等上下文给出建议；可多轮对话。
  - 约束：不知道的数据不编造；涉及具体数据时建议用户到某页面查看。
- 可在 `application.yml` 的 `ai.system-prompt` 里配置多行，便于后续调优。

### 4. 可选后续方向（真正「智能」）

- **RAG**：把帮助文档、操作手册做成向量，根据问题检索后再交给模型生成，回答更贴系统实际。
- **Tool / 函数调用**：模型可请求「查当前用户本周周报」「查提交率」等，后端执行后把结果再塞回对话，模型再生成最终回复。
- **流式输出**：用 SSE 流式返回 content，前端逐字展示，体验更自然。

---

## 三、小结

- **当前接入逻辑**：单轮、无历史、无用户与业务上下文，仅「固定 system + 一条 user」调 DeepSeek，所以更像搜索式 QA。
- **问答生成方式**：完全由 DeepSeek 根据「一句 system + 一句 user」生成一段回复，没有记忆和个性化。
- **改进后**：多轮历史 + 用户/周次等上下文注入 + 更清晰的 system 角色设定，在不改接口协议的前提下，让同一套 DeepSeek 接入更接近「智能对话」而不是「单次搜索」。

上述多轮与上下文逻辑已在后端与前端实现：
- **后端**：`AiService.chatWithContext(message, history, contextInfo)`；`AiController.assist` 接收 `{ message, history?, context? }`，从 request 取 username，与前端传入的 `context.currentWeek` 拼成上下文字符串注入 system。
- **前端**：AI 助手抽屉发送时带 `history`（当前会话中本条之前的消息）和 `context: { currentWeek }`。
