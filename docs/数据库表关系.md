# 企业周报管理系统 - 数据库表关系说明

## 一、数据库概览

- **数据库名**：`weekly_report`
- **字符集**：utf8mb4 / utf8mb4_unicode_ci
- **表数量**：4 张业务表（部门、角色、用户、周报）

---

## 二、表清单与说明

| 表名 | 说明 |
|------|------|
| sys_department | 部门表（树形，parent_id 自关联） |
| sys_role | 角色表（含权限 JSON） |
| sys_user | 用户表（关联部门、角色） |
| weekly_report | 周报表（关联用户、评审人） |

---

## 三、表结构详情

### 3.1 sys_department（部门表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| name | VARCHAR(100) | 部门名称 |
| parent_id | BIGINT DEFAULT 0 | 上级部门 ID，0 表示根节点 |
| sort | INT DEFAULT 0 | 排序 |
| create_time | DATETIME | 创建时间 |
| deleted | TINYINT DEFAULT 0 | 逻辑删除（0 未删） |

**索引**：parent_id  
**关系**：自关联，parent_id → sys_department.id，构成树形结构。

---

### 3.2 sys_role（角色表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| name | VARCHAR(50) | 角色名称 |
| code | VARCHAR(50) UNIQUE | 角色编码（如 ADMIN、LEADER、STAFF） |
| description | VARCHAR(255) | 描述 |
| permissions | TEXT | 权限 JSON（如 ["*"] 或 ["report:view","team:review"]） |
| status | TINYINT DEFAULT 1 | 状态：0 禁用，1 启用 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |
| deleted | TINYINT DEFAULT 0 | 逻辑删除 |

**索引**：code  
**关系**：被 sys_user 引用（user.role_id → sys_role.id）。

---

### 3.3 sys_user（用户表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| username | VARCHAR(50) | 用户名 |
| email | VARCHAR(100) UNIQUE | 邮箱（登录账号） |
| password | VARCHAR(100) | 密码（如 MD5 存储） |
| department_id | BIGINT | 所属部门 ID |
| role_id | BIGINT | 角色 ID |
| status | TINYINT DEFAULT 1 | 状态：0 禁用，1 启用 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |
| deleted | TINYINT DEFAULT 0 | 逻辑删除 |

**索引**：email, department_id, role_id  
**关系**：
- department_id → sys_department.id（多对一）
- role_id → sys_role.id（多对一）

---

### 3.4 weekly_report（周报表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| user_id | BIGINT NOT NULL | 填报人用户 ID |
| week_number | INT NOT NULL | 周次（1–53） |
| year | INT NOT NULL | 年份 |
| this_week_work | TEXT | 本周工作完成情况 |
| next_week_plan | TEXT | 下周工作计划 |
| coordination | TEXT | 需协调事项 |
| status | TINYINT DEFAULT 0 | 状态：0 草稿，1 已提交 |
| score | DECIMAL(3,1) | 评分（如 4.5） |
| comment | TEXT | 评语 |
| reviewer_id | BIGINT | 评分人用户 ID |
| submit_time | DATETIME | 提交时间 |
| review_time | DATETIME | 评分时间 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |
| deleted | TINYINT DEFAULT 0 | 逻辑删除 |

**索引**：user_id, (year, week_number)  
**唯一约束**：uk_user_week (user_id, year, week_number) — 每人每年每周一条周报。  
**关系**：
- user_id → sys_user.id（多对一，填报人）
- reviewer_id → sys_user.id（多对一，评分人，可为空）

---

## 四、表关系图（文字描述）

```
                    sys_department
                    (自关联树形)
                          │
         parent_id        │ id
        ┌─────────────────┘
        │
        ▼
┌───────────────┐     department_id      ┌───────────────┐
│  sys_department │◄──────────────────────│   sys_user    │
└───────────────┘                        └───────┬───────┘
                                                 │
                    role_id                     │ id
        ┌──────────────────────────────────────┼──────────────────┐
        │                                      │                  │
        ▼                                      ▼                  ▼
┌───────────────┐                        ┌─────────────────────────────┐
│   sys_role    │                        │      weekly_report          │
└───────────────┘                        │  user_id ────► 填报人       │
        ▲                                 │  reviewer_id ──► 评分人(可空) │
        │                                 └─────────────────────────────┘
        │
   role_id (sys_user.role_id)
```

---

## 五、关系汇总

| 关系 | 类型 | 说明 |
|------|------|------|
| sys_department ↔ sys_department | 自关联（树） | parent_id → id，多级部门 |
| sys_user → sys_department | 多对一 | 用户属于一个部门 |
| sys_user → sys_role | 多对一 | 用户拥有一个角色 |
| weekly_report → sys_user（填报人） | 多对一 | 每条周报属于一个用户 |
| weekly_report → sys_user（评分人） | 多对一（可空） | 评分人也是用户 |

**说明**：
- 部门、角色、用户、周报均使用逻辑删除（deleted），无物理外键，关联在应用层（MyBatis-Plus / 手写 SQL）维护。
- 周报与用户通过 user_id、reviewer_id 在查询时 JOIN sys_user、sys_department 得到用户名、部门名等展示字段。

---

## 六、初始数据概要（schema.sql）

- **部门**：1 个公司根节点，下挂研发部、后端组、前端组、产品部、市场部等。
- **角色**：管理员(ADMIN)、组长(LEADER)、员工(STAFF)，权限 JSON 不同。
- **用户**：管理员 1 个，其余为张三/李四/王五/赵六，归属不同部门与角色，密码均为 123456 的 MD5。
- **周报**：若干条示例周报（user_id=2、3，2024 年第 2 周等），用于演示列表与评分。

---

*文档依据 `weekly-report-backend/src/main/resources/db/schema.sql` 及实体类整理，表名、字段以实际库表为准。*
