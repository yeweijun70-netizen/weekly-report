# 组织机构管理 & 操作日志管理 — 实现步骤指南

本文档说明在「系统管理」菜单下新增**组织机构管理**、**操作日志管理**两个功能时，需要做的操作及顺序。代码已按步骤实现，你可按下面清单自检或复现。

---

## 一、整体要做的事

| 步骤 | 内容 | 说明 |
|------|------|------|
| 1 | 数据库：操作日志表 | 新增 `sys_operation_log` 表 |
| 2 | 后端：操作日志实体/Mapper/Service/Controller | 分页查询、记录日志 |
| 3 | 后端：记录每条请求的日志 | 拦截器解析 JWT 并写入操作人，请求结束后写入日志 |
| 4 | 前端：路由与菜单 | 新增「组织机构管理」「操作日志管理」入口 |
| 5 | 前端：组织机构管理页 | 部门树 + 新增/编辑/删除 |
| 6 | 前端：操作日志管理页 | 表格 + 按操作人/模块/时间筛选 + 分页 |

---

## 二、你需要逐步完成的操作

### 步骤 1：数据库增加操作日志表

**目的**：存每条操作记录（谁、什么模块、什么操作、URL、IP、耗时、时间）。

**操作**：

- **若是新装库**：已在本项目的 `schema.sql` 末尾追加了 `sys_operation_log` 建表语句，直接执行完整 `schema.sql` 即可。
- **若库已存在**：在 MySQL 中执行 `weekly-report-backend/src/main/resources/db/operation_log.sql`（只建操作日志表）。

执行后确认存在表 `weekly_report.sys_operation_log`。

---

### 步骤 2：后端 — 操作日志 CRUD 与分页

**目的**：能「写一条日志」和「分页查日志」。

**已有文件**（无需再建，仅作对照）：

- `entity/OperationLog.java` — 对应 `sys_operation_log` 表字段。
- `mapper/OperationLogMapper.java` — 继承 `BaseMapper<OperationLog>`。
- `service/OperationLogService.java` — `pageList(用户名、模块、开始/结束时间)`、`saveLog(...)`。
- `controller/OperationLogController.java` — `GET /operation-log/page` 分页查询。

**自检**：启动后端，访问 http://localhost:8080/doc.html ，确认有「操作日志管理」分组及接口 `GET /operation-log/page`。

---

### 步骤 3：后端 — 每条请求自动记一条日志

**目的**：用户每次请求（登录、点菜单、保存等）都在库里留一条记录。

**已有修改**：

1. **JwtAuthInterceptor**  
   - 从请求头 `Authorization: Bearer <token>` 解析 JWT，校验通过后把 `userId`、`username` 放进 `request.setAttribute`，供日志拦截器使用。

2. **OperationLogInterceptor**  
   - `preHandle`：在 request 里记录开始时间。  
   - `afterCompletion`：根据 request 中的 userId/username、请求 URL、方法、IP、耗时，调用 `OperationLogService.saveLog(...)` 写入一条记录。  
   - 模块/操作名根据 URL 前缀映射（如 `/auth` → 认证，`/user` → 用户管理，`/department` → 组织机构）。

3. **WebConfig**  
   - 注册 `OperationLogInterceptor`，拦截除文档、静态资源外的所有路径。

**自检**：登录后随便点几个菜单或保存一次用户/部门，再在「操作日志管理」页或直接调 `GET /operation-log/page` 看是否有新记录。

---

### 步骤 4：前端 — 路由与菜单

**目的**：在系统管理下出现两个新菜单，且能跳转到对应页面。

**已有修改**：

- **router/index.js**  
  - 在 `children` 中增加：  
    - `path: 'org-management'` → `OrgManagement.vue`，`meta: { title: '组织机构管理' }`  
    - `path: 'operation-log'` → `OperationLog.vue`，`meta: { title: '操作日志管理' }`
- **Layout.vue**  
  - 在「系统管理」的 `el-sub-menu` 下增加：  
    - `<el-menu-item index="/org-management">组织机构管理</el-menu-item>`  
    - `<el-menu-item index="/operation-log">操作日志管理</el-menu-item>`

**自检**：刷新前端，左侧「系统管理」展开后应看到「组织机构管理」「操作日志管理」，点击能进入对应页面且浏览器标题正确。

---

### 步骤 5：前端 — 组织机构管理页

**目的**：以树形展示部门，支持新增根部门、添加子部门、编辑、删除。

**已有文件**：`views/OrgManagement.vue`

**逻辑概要**：

- 调用 `getDepartmentTree()` 拉取部门树，用 `el-tree` 展示。
- 搜索框根据部门名称过滤树节点。
- 工具栏「新增根部门」、树节点上「添加子部门」「编辑」「删除」：
  - 新增/编辑：弹窗表单（部门名称、排序），提交调用 `saveDepartment`。
  - 删除：确认后调用 `deleteDepartment(id)`。
- 部门接口复用现有 `GET /department/tree`、`POST /department`、`DELETE /department/:id`。

**api/index.js** 已增加：`saveDepartment`、`deleteDepartment`。

**自检**：进入「组织机构管理」，能看到树；新增/编辑/删除后列表刷新且无报错。

---

### 步骤 6：前端 — 操作日志管理页

**目的**：分页展示操作日志，支持按操作人、模块、时间范围筛选。

**已有文件**：`views/OperationLog.vue`

**逻辑概要**：

- 表格列：ID、操作人、模块、操作、请求方法、请求URL、IP、耗时(ms)、操作时间。
- 筛选：操作人（模糊）、模块（模糊）、日期范围；点击「搜索」或回车触发查询。
- 分页：调用 `getOperationLogPage(params)`，params 含 current、size、username、module、startTime、endTime。

**api/index.js** 已增加：`getOperationLogPage`。

**自检**：进入「操作日志管理」，应有数据（若刚加功能可先多点击几个菜单再查）；改筛选条件、分页正常。

---

## 三、文件清单（便于你对照）

| 类型 | 路径 |
|------|------|
| 数据库 | `weekly-report-backend/src/main/resources/db/operation_log.sql`（单独执行用）；`schema.sql` 末尾已含操作日志表 |
| 后端实体 | `entity/OperationLog.java` |
| 后端 Mapper | `mapper/OperationLogMapper.java` |
| 后端 Service | `service/OperationLogService.java` |
| 后端 Controller | `controller/OperationLogController.java` |
| 后端配置 | `config/JwtAuthInterceptor.java`（解析 token 设 userId/username）；`config/OperationLogInterceptor.java`；`config/WebConfig.java`（注册日志拦截器） |
| 前端路由 | `router/index.js` |
| 前端布局 | `views/Layout.vue` |
| 前端页面 | `views/OrgManagement.vue`、`views/OperationLog.vue` |
| 前端 API | `api/index.js`（getDepartmentTree、saveDepartment、deleteDepartment、getOperationLogPage） |

---

## 四、建议自测顺序

1. 执行操作日志表 SQL（新库用 schema.sql，已有库用 operation_log.sql）。  
2. 启动后端，确认无报错，doc 里能看到操作日志接口。  
3. 启动前端，确认系统管理下有两个新菜单且能打开。  
4. 登录后操作几下（切换菜单、编辑用户/部门），再打开「操作日志管理」看是否有记录。  
5. 在「组织机构管理」里新增/编辑/删除部门，确认树刷新正常。

按上述步骤做完，即完成「系统管理 → 组织机构管理、操作日志管理」两个功能的实现与自检。
